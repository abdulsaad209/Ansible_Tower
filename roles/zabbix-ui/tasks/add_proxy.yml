---
###########################################################
# 1. Authenticate â€“ Get Zabbix API token
###########################################################
- name: Get Zabbix API token
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    body_format: json
    headers:
      Content-Type: "application/json-rpc"
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_pass }}"
      id: 1
    validate_certs: false
  register: zbx_login

- set_fact:
    zbx_token: "{{ zbx_login.json.result }}"


###########################################################
# 2. Check if the Proxy already exists
###########################################################
- name: Check if Zabbix Proxy already exists
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.get"
      params:
        search:
          name: "{{ proxy_name }}"
        output: ["proxyid", "name"]
      id: 2
    validate_certs: false
  register: proxy_check

- name: Set existing proxy ID (safe)
  set_fact:
    existing_proxy_id: "{{ proxy_check.json.result[0].proxyid | default('') }}"

###########################################################
# 3. Create Proxy if NOT exists
###########################################################
- name: Create Zabbix proxy
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.create"
      params:
        name: "{{ proxy_name }}"
        operating_mode: "{{ proxy_mode }}"   # "0"=Active, "1"=Passive
        address: "{{ proxy_ip | default(omit) }}"  # only for passive
        port: "{{ proxy_port | default(omit) }}"   # only for passive
        hosts: "{{ proxy_hosts | default([]) }}"   # list of dicts with hostid
        proxy_groupid: "{{ proxy_groupid | default(omit) }}"
      id: 1
    validate_certs: false
  register: proxy_create

- name: Update existing Zabbix Proxy
  when: existing_proxy_id != ""
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.update"
      params:
        proxyid: "{{ existing_proxy_id }}"
        name: "{{ proxy_name }}"
        operating_mode: "{{ proxy_mode }}"  # "0"=Active, "1"=Passive
        address: "{{ proxy_ip | default(omit) }}"  # only for passive
        port: "{{ proxy_port | default(omit) }}"   # only for passive
        hosts: "{{ proxy_hosts | default(omit) }}"  # optional list of hostids
        proxy_groupid: "{{ proxy_groupid | default(omit) }}"  # optional
      id: 4
    validate_certs: false
  register: proxy_update
