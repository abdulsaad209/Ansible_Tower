---
###########################################################
# 1. Authenticate â€“ Get Zabbix API token
###########################################################
- name: Get Zabbix API token
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    body_format: json
    headers:
      Content-Type: "application/json-rpc"
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_pass }}"
      id: 1
    validate_certs: false
  register: zbx_login

- set_fact:
    zbx_token: "{{ zbx_login.json.result }}"


###########################################################
# 2. Check if the Proxy already exists
###########################################################
- name: Check if Zabbix Proxy already exists
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.get"
      params:
        search:
          name: "{{ proxy_name }}"
        output: ["proxyid", "name"]
      id: 2
    validate_certs: false
  register: proxy_check

###########################################################
# 3. Create Proxy if NOT exists
###########################################################
- name: Create new Zabbix Proxy
  when: existing_proxy_id == ""
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.create"
      params:
        name: "{{ proxy_name }}"
        mode: "{{ proxy_mode }}"     # 1=Active, 2=Passive
        interface:
          ip: "{{ proxy_ip }}"
          dns: ""
          port: "10051"
          useip: 1
      id: 3
    validate_certs: false
  register: proxy_create

###########################################################
# 4. Update Proxy if exists
###########################################################
- name: Update existing Zabbix Proxy
  when: existing_proxy_id != ""
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.update"
      params:
        proxyid: "{{ existing_proxy_id }}"
        name: "{{ proxy_name }}"
        mode: "{{ proxy_mode }}"
        interface:
          ip: "{{ proxy_ip }}"
          dns: ""
          port: "10051"
          useip: 1
      id: 4
    validate_certs: false
  register: proxy_update
  