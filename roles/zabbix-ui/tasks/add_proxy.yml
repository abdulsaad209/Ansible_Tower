---
###########################################################
# 1. Authenticate â€“ Get Zabbix API token
###########################################################
- name: Get Zabbix API token
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    body_format: json
    headers:
      Content-Type: "application/json-rpc"
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_pass }}"
      id: 1
    validate_certs: false
  register: zbx_login

- set_fact:
    zbx_token: "{{ zbx_login.json.result }}"


###########################################################
# 2. Check if the Proxy already exists
###########################################################
- name: Check if Zabbix Proxy already exists
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "proxy.get"
      params:
        search:
          name: "{{ proxy_name }}"
        output: ["proxyid", "name"]
      id: 2
    validate_certs: false
  register: proxy_check

- name: Set existing proxy ID (safe)
  set_fact:
    existing_proxy_id: "{{ proxy_check.json.result[0].proxyid | default('') }}"

###########################################################
# 3. Create Proxy if NOT exists
###########################################################
- name: Create or update Zabbix Proxy
  uri:
    url: "{{ zabbix_url }}/api_jsonrpc.php"
    method: POST
    headers:
      Content-Type: "application/json-rpc"
      Authorization: "Bearer {{ zbx_token }}"
    body_format: json
    body:
      jsonrpc: "2.0"
      method: "{{ 'proxy.create' if existing_proxy_id == '' else 'proxy.update' }}"
      params: >-
        {{

          {
            'name': proxy_name,
            'operating_mode': proxy_mode,
            'hosts': proxy_hosts | default(omit),
            'proxy_groupid': {{ proxy_group_name }},
            'proxyid': existing_proxy_id if existing_proxy_id != '' else omit,
            'address': proxy_ip if proxy_mode == '1' else omit,
            'port': proxy_port if proxy_mode == '1' else omit
          }
        }}
      id: 1
    validate_certs: false
  register: proxy_result
